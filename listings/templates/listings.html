{% extends 'base.html' %}

{% block content %}
<section class="listing-section" id="listing-section">
    <div id="searchFormContainer">
        <!-- Active Filters Display -->
        <div id="activeFilters" class="active-filters" style="display: none;">
            <h4>Active Filters:</h4>
            <div class="filter-tags" id="filterTags"></div>
        </div>

        <form class="search-form" method="get" action="/listings2/">
            <!-- Search Query -->
            <div class="form-group">
                <label for="search-query">Search Properties</label>
                <input type="text" id="search-query" name="q" class="form-input" 
                       placeholder="Search by title or description" value="">
            </div>

            <!-- Location -->
            <div class="form-group">
                <label for="location">Location</label>
                <select id="location" name="location" class="form-select">
                    <option value="">All Locations</option>
                    <option value="kuala-lumpur">Kuala Lumpur</option>
                    <option value="selangor">Selangor</option>
                    <option value="penang">Penang</option>
                    <option value="johor">Johor</option>
                </select>
            </div>

            <!-- Price Range -->
            <div class="form-group">
                <label>Price Range (RM)</label>
                <div class="price-range">
                    <input type="number" name="min_price" class="form-input" 
                           placeholder="Min Price" value="">
                    <input type="number" name="max_price" class="form-input" 
                           placeholder="Max Price" value="">
                </div>
            </div>

            <!-- Property Type -->
            <div class="form-group">
                <label for="property-type">Property Type</label>
                <select id="property-type" name="property_type" class="form-select">
                    <option value="">All Types</option>
                    <option value="House">House</option>
                    <option value="Apartment">Apartment</option>
                    <option value="Commercial">Commercial</option>
                    <option value="Land">Land</option>
                </select>
            </div>

            <!-- Room Size -->
            <div class="form-group">
                <label for="room-size">Room Size</label>
                <select id="room-size" name="size" class="form-select">
                    <option value="">Any Size</option>
                    <option value="Small">Small</option>
                    <option value="Medium">Medium</option>
                    <option value="Large">Large</option>
                    <option value="Master">Master</option>
                </select>
            </div>

            <!-- Room Count -->
            <div class="form-group">
                <label for="room-count">Room Count</label>
                <input type="number" id="room-count" name="room_count" class="form-input" 
                       placeholder="Number of rooms" min="1" value="">
            </div>

            <!-- Listing Type -->
            <div class="form-group">
                <label for="listing-type">Listing Type</label>
                <select id="listing-type" name="listing_type" class="form-select">
                    <option value="">All Listings</option>
                    <option value="For Sale">For Sale</option>
                    <option value="For Rent">For Rent</option>
                    <option value="Auction">Auction</option>
                </select>
            </div>

            <!-- Availability -->
            <div class="form-group">
                <label for="availability">Availability</label>
                <select id="availability" name="availability" class="form-select">
                    <option value="">Any Availability</option>
                    <option value="Immediate">Immediate</option>
                    <option value="Coming Soon">Coming Soon</option>
                </select>
            </div>

            <!-- Condition -->
            <div class="form-group">
                <label for="condition">Condition</label>
                <select id="condition" name="condition" class="form-select">
                    <option value="">Any Condition</option>
                    <option value="New">New</option>
                    <option value="Renovated">Renovated</option>
                    <option value="Pre-owned">Pre-owned</option>
                </select>
            </div>

            <!-- Furnishing -->
            <div class="form-group">
                <label for="furnishing">Furnishing</label>
                <select id="furnishing" name="furnishing" class="form-select">
                    <option value="">Any Furnishing</option>
                    <option value="Unfurnished">Unfurnished</option>
                    <option value="Partially Furnished">Partially Furnished</option>
                    <option value="Fully Furnished">Fully Furnished</option>
                </select>
            </div>

            <!-- Featured Checkbox -->
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="featured" name="featured" class="checkbox-input">
                    <label for="featured" class="checkbox-label">Featured Properties Only</label>
                </div>
            </div>

            <!-- Property Features -->
            <div class="features-section">
                <div class="features-legend">Property Features</div>
                <button type="button" class="features-button" onclick="openFeatureModal()">
                    Select Features
                </button>
                <p class="features-description">Click to choose specific property features</p>
                <div id="selectedFeaturesDisplay" class="filter-tags" style="margin-top: 12px;"></div>
            </div>

            <!-- Submit Buttons -->
            <div class="submit-section">
                <button type="submit" class="search-submit">Apply Filters</button>
                <button type="button" class="clear-filters" onclick="clearAllFilters()">Clear All</button>
            </div>
        </form>
    </div>

    <!-- Feature Selection Modal -->
    <div id="featureModal" class="feature-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Select Property Features</h2>
                <span class="close-modal" onclick="closeFeatureModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="modalFeatureForm" method="GET" action="{% url 'listings2' %}">
                    <!-- Features populated from database -->
                    {% for feature in all_features %}
                        <label class="feature-option">
                            <input type="checkbox" name="features" value="{{ feature.id }}" class="feature-checkbox"
                                {% if feature.id|stringformat:"s" in selected_features %}checked{% endif %}>
                            <span>{{ feature.name }}</span>
                        </label>
                    {% endfor %}
                    
                    <!-- Hidden fields to preserve other filter values -->
                    <input type="hidden" name="q" value="{{ request.GET.q }}">
                    <input type="hidden" name="location" value="{{ request.GET.location }}">
                    <input type="hidden" name="min_price" value="{{ request.GET.min_price }}">
                    <input type="hidden" name="max_price" value="{{ request.GET.max_price }}">
                    <input type="hidden" name="property_type" value="{{ request.GET.property_type }}">
                    <input type="hidden" name="size" value="{{ request.GET.size }}">
                    <input type="hidden" name="room_count" value="{{ request.GET.room_count }}">
                    <input type="hidden" name="listing_type" value="{{ request.GET.listing_type }}">
                    <input type="hidden" name="availability" value="{{ request.GET.availability }}">
                    <input type="hidden" name="condition" value="{{ request.GET.condition }}">
                    <input type="hidden" name="furnishing" value="{{ request.GET.furnishing }}">
                    {% if request.GET.featured == 'on' %}
                        <input type="hidden" name="featured" value="on">
                    {% endif %}
                    
                    <button type="button" class="modal-submit" onclick="applyFeatures()">Apply Features</button>
                </form>
            </div>
        </div>
    </div>

    <div class="property-listing-container">
        {% for property in properties %}
            <div class="property-card">
                {% if property.images.all %}
                    <img src="{{ property.images.first.image.url }}" alt="Property Image" class="property-image">
                {% else %}
                    <img src="/path/to/default/image.jpg" alt="Default Property Image" class="property-image">
                {% endif %}
                <div class="property-details">
                    <h2 class="property-title">{{ property.title }}</h2>
                    <p class="property-location">{{ property.location }}</p>
                    <p class="property-price">RM{{ property.price|floatformat:2 }}</p>
                    <p class="property-description">{{ property.description|truncatewords:20 }}</p>
                    {% if property.id %}
                        <a href="{% url 'property_detail' property.id %}" class="view-details-button">View Details</a>
                    {% else %}
                        <span class="view-details-button disabled">No Details</span>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <p>No properties available at the moment.</p>
        {% endfor %}
    </div>
    <div class="pagination">
        <span class="step-links">
            {% if properties.has_next %}
                <a href="?page={{ properties.next_page_number }}" class="pagination-link">next</a>
                <a href="?page={{ properties.paginator.num_pages }}" class="pagination-link">last &raquo;</a>
            {% endif %}
            {% if properties.has_previous %}
                <a href="?page=1" class="pagination-link">&laquo; first</a>
                <a href="?page={{ properties.previous_page_number }}" class="pagination-link">previous</a>
            {% endif %}

            <span class="current">
                Page {{ properties.number }} of {{ properties.paginator.num_pages }}.
            </span>
        </span>
    </div>
</section>

<div id="featureModal" class="feature-modal modal" style="display: none;">
    <div class="modal-content">
        <span class="close-feature" onclick="closeFeatureModal()">&times;</span>
        <h2>Select Property Features</h2>
        <form id="modalFeatureForm" method="GET" action="{% url 'listings' %}">
            {% for feature in all_features %}
                <label>
                    <input type="checkbox" name="features" value="{{ feature.id }}"  
                        {% if feature.id|stringformat:"s" in selected_features %}checked{% endif %}>
                    {{ feature.name }}
                </label><br>
            {% endfor %}
            <input type="hidden" name="q" value="{{ request.GET.q }}">
            <input type="hidden" name="location" value="{{ request.GET.location }}">
            <input type="hidden" name="min_price" value="{{ request.GET.min_price }}">
            <input type="hidden" name="max_price" value="{{ request.GET.max_price }}">
            <input type="hidden" name="property_type" value="{{ request.GET.property_type }}">
            <input type="hidden" name="size" value="{{ request.GET.size }}">
            <input type="hidden" name="room_count" value="{{ request.GET.room_count }}">
            <input type="hidden" name="listing_type" value="{{ request.GET.listing_type }}">
            <input type="hidden" name="availability" value="{{ request.GET.availability }}">
            <input type="hidden" name="condition" value="{{ request.GET.condition }}">
            <input type="hidden" name="furnishing" value="{{ request.GET.furnishing }}">
            {% if request.GET.featured == 'on' %}
                <input type="hidden" name="featured" value="on">
            {% endif %}
            <button type="submit">Apply</button>
        </form>
    </div>
</div>



{% endblock %}
